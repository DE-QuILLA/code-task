
## 카프카 프로듀서 모듈화 구조 정리

1. 구독할 데이터, 웹소켓 정리하기

- 마켓 데이터
    - 티커 - 레벨 1 => 현재 한 심볼의 요약 정보 (최고 매수가 등)
    - 북 - 레벨 2 => 호가창 정보
    - 캔들 - 캔들 정보 => 
    - 트레이드 - 거래 트랜잭션
    - instrument (아마 안씀) - 현재 활성화 거래쌍 목록 

- ping: 각 소켓에 보내는 정도로 괜찮을거같음. 5초정도???


2. 모듈화 구조

- WebSocketClientManager
    - 웹소켓 클라이언트들을 생성하고 관리
    - 카프카 프로듀서도 생성하고 웹소켓 클라이언트에 붙혀준다.
    - 내 코드의 엔트리 포인트가 된다.

- WebSocketClient
    - 웹소켓으로의 커넥션 1개를 의미
    - 여기에 url별로 구독한다. (다른 엔드포인트 구독은 다른 WebSocketClient 객체로서 관리된다.)
    - 여기서 메시지를 받아올 수 있다. 
    - 받으면 지정된 프로듀서로 넘긴다.

- KafkaClient
    - 카프카로의 커넥션 1개를 의미
    - 우선 1개로 시작하겠음. 
        - 얘가 수가 적다고 네트워크 병목이 되는 경우가 거의 없으며, 수천개의 커넥션을 연결해도 카프카는 결국 내부적으로 커넥션 최적화를 한다고 함. by 지피티 선생님
    - 내부적으로 아마 KafkaProducer 라이브러리의 send가 비동기인듯? 딱히 지피티 선생님은 await 같은걸 언급하지 않음.

- ActivePairManager
    - 구독할 거래쌍 정보를 저장하고, 갱신하는 데에 사용됨.
    - set 형태로 데이터를 관리하고, fast api를 통해서 특정 명령이 들어오면 Redis로 가서 읽어와서, 내쪽의 거래쌍을 갱신함.
    - 이 때 거래쌍 변화가 일어나면 결과적으로 WebSocketClient에서 새로 구독할 거래쌍, 삭제할 거래쌍의 목록을 받아가서 구독취소, 새로운 구독을 할 수 있어야함.
    - 이런 명령 구조를 생각했을 때, 이 친구는 클라이언트 매니저에서 초기화되고 관리되어야할듯하다.

- RedisClient
    - 필요할지는 모르겠는데 ... 레디스에서도 비동기적으로 읽어오면 세션 관리가 필요할까 해서 하나 생성해둘까. 했움. 

- KrakenStandardLogger 
    - 각 객체가 자기 component name 기반으로 로깅 남기는데 사용

- KrakenStatusManager
    - 각 객체의 상태 관리 등 종합 관리

작업 순서


1. 로거: 모든 컴포넌트가 가지고 있어야 함

2. 스테이터스 매니저: 모든 컴포넌트가 가지고 있어야 함 (한 개를 공유)

3. Redis Client => Active Pair manager

4. Kafka Client, Websocketclient => Websoccketclientmanager


모듈/폴더 경로	파일명	클래스/함수명	역할 설명
kraken_producer_core/manager/	websocket_client_manager.py	WebSocketClientManager	전체 클라이언트 생성, 갱신, 종료 조율
kraken_producer_core/websocket/	websocket_client.py	WebSocketClient	하나의 웹소켓 커넥션 담당 (채널별)
kraken_producer_core/kafka/	kafka_producer_client.py	KafkaProducerClient	Kafka 메시지 전송 담당, produce만 수행
kraken_producer_core/store/	redis_active_pair_store.py	RedisActivePairStore	Redis에서 거래쌍 목록 읽기/저장
kraken_producer_core/manager/	active_pair_manager.py	ActivePairManager	RedisStore를 래핑하여 symbol list 상태 관리
kraken_producer_core/config/	websocket_config_models.py	KrakenWebSocketConfigModel, 등	각 채널의 구독 메시지 설정 데이터 모델
kraken_producer_core/utils/	retry_wrapper.py	custom_retry()	retry + timeout + logging 래핑 함수
kraken_producer_core/utils/	stdout_logger.py	get_stdout_logger()	stdout stream 전용 logger 설정
kraken_producer_core/fastapi/	app_factory.py	create_app()	FastAPI 앱 생성, lifespan 관리
kraken_producer_core/entrypoint/	kraken_producer_main.py	kraken_fast_api_app	앱 인스턴스 초기화, manager 구성
kraken_producer_core/entrypoint/	kraken_producer_run.py	uvicorn.run(...)	FastAPI 실행 entrypoint 스크립트

